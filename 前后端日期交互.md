# Spring与Spring Boot项目中日期字段的前后端交互

代码示例请查看[网站](https://github.com/ouyangjunfei/SSMIntegration)

后端数据的读取包含两种情况

1. 使用模板引擎 (JSP, Thymeleaf, Freemarker) 等，直接把数据渲染到模板，此过程不经过 `RequestMappingHandlerAdapter` 处理返回值，故使用的注释 `JsonFormat` 不会起作用，如果需要渲染指定的日期格式，需要根据具体模板引擎的语法进行修饰
2. 使用 `@ResponseBody` 注解只请求数据时，与上面过程不同，`JsonFormat` 注解会起作用

这部分的区别可以查看`BookController.java`源码这部分，并使用类似[Postman](https://www.postman.com/)的工具测试一下

```java
// 查询全部的书籍，并且返回到一个书籍展示页面
@GetMapping(value = "/all")
public String queryAllBooksPage(Model model) {
    List<Book> bookList = bookService.queryAllBooks();
    model.addAttribute("list", bookList);
    return "book";
}

// 查询全部书籍的数据
@PostMapping("/all")
@ResponseBody
public List<Book> queryAllBooksData() {
    List<Book> bookList = bookService.queryAllBooks();
    return bookList;
}
```



## 1. Spring项目(SSM架构)

### 1.1 默认情况

**没有引入** `Jackson` **依赖**

**配置文件只使用**

```xml
<mvc:annotation-driven/>
```

实体类不加任何注解，表示时间的字段使用 `Date` 类修饰，传回前端的结果由 `Date` 类内部的 `toString()` 方法转换，具体定义如下

```java
Converts this Date object to a String of the form:
       dow mon dd hh:mm:ss zzz yyyy
where:
dow is the day of the week (Sun, Mon, Tue, Wed, Thu, Fri, Sat).
mon is the month (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec).
dd is the day of the month (01 through 31), as two decimal digits.
hh is the hour of the day (00 through 23), as two decimal digits.
mm is the minute within the hour (00 through 59), as two decimal digits.
ss is the second within the minute (00 through 61, as two decimal digits.
zzz is the time zone (and may reflect daylight saving time). Standard time zone abbreviations include those recognized by the method parse. If time zone information is not available, then zzz is empty - that is, it consists of no characters at all.
yyyy is the year, as four decimal digits.
```

所以其返回前端的日期形态如下，而正常我想得到的日期应该是形如`yyyy-MM-dd`形态的

> Tue May 18 00:00:00 CST 2021

同时，前端的修改字段功能也会直接报错

> org.springframework.core.convert.ConversionFailedException: Failed to convert from type [java.lang.String] to type [java.util.Date] for value '2021-06-01'

直接用`Post`测试获取数据也失败，报错信息

> No converter found for return value of type: class java.util.ArrayList

这里涉及到更深层次的Spring MVC对返回值的处理过程，具体原理可以网上查询

经过本人的测试得到结果，目前的返回值只支持`String`类型，其他一律会出现如上的没有对应converter的错误

具体源码位置可以查看方法`org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor#writeWithMessageConverters`

### 1.2 实体类增加Spring的注解

为实体类的日期字段加上注解

```java
@DateTimeFormat(pattern = "yyyy-MM-dd")
```

之后前端发起的修改就可以成功，参考注解的文档说明第一句

> Declares that a field or method parameter should be formatted as a date or time.

只有如此声明才可以把指定的日期字符串转化为我们想要的日期格式

但此时读取的日期还是如 `1.1` 的格式，并且`Post`方式获取数据同样错误

### 1.3 引入Jackson依赖

```xml
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>${jackson.version}</version>
</dependency>
```

不要忘记在`Artifacts`中把依赖包加入`lib`文件夹

此时通过`Post`已经可以得到JSON格式的数据，但是日期的内容为时间戳的表示形式

```json
[
    {
        "bookName": "Java",
        "bookCounts": 0,
        "detail": "从入门到放弃",
        "bookDate": 1617206400000,
        "bookID": 1
    },
    ...
]
```

需要给实体类加上对应的注解

```java
@JsonFormat(pattern = "yyyy-MM-dd", timezone = "GMT+8")
```

此时再通过`Post`方法得到数据就是我们想要的包含指定格式的日期数据

```json
[
    {
        "bookName": "Java",
        "bookCounts": 0,
        "detail": "从入门到放弃",
        "bookDate": "2021-04-01",
        "bookID": 1
    },
    ...
]
```

下面讲解如何把页面中的日期格式化

### 1.4 JSP页面的日期格式化

日期格式化也完全可以交给前端去做，但是由于我们使用的是模板引擎，何不一次性搞定

针对于不同的模板引擎，日期格式化的方式都各有不同，但是可以肯定的是都提供了对应的方法

此项目中使用的是JSP页面

首先需要加入`JSP标准标签库`

```jsp
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
```

之后在你想用到日期的值的位置写入

```jsp
<fmt:formatDate value="${book.bookDate}" pattern="yyyy-MM-dd"/>

value表示后端传来的值，pattern是想要得到的日期格式
```

刷新页面，可以得到正确的日期形式

<img src="assets/image-20210526001308596.png" alt="image-20210526001308596" style="zoom:67%;" />

## 2. Spring Boot项目



